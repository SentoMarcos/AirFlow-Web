<!doctype html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>AirFlow | Salud</title>
  <link rel="icon" href="img/icon_retrofit.png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/airflow-salud.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-routing-machine/3.2.12/leaflet-routing-machine.min.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
</head>
<body class="loading">
<div id="header-container"></div>

<div id="container-salud">
    <div id="lado">
        <div id="calendario">
            <div id="dias-semana">
                <span>Dom</span>
                <span>Lun</span>
                <span>Mar</span>
                <span>Mié</span>
                <span>Jue</span>
                <span>Vie</span>
                <span>Sáb</span>
            </div>
            <div id="dias">
                <!-- Aquí van los días del mes -->
            </div>
            <header>
                <div id="navegacion">
                    <button id="mes-anterior">&lt;</button>
                    <h2 id="mes-actual">Diciembre 2023</h2>
                    <button id="mes-siguiente">&gt;</button>
                </div>
            </header>
        </div>
    </div>  <div id="main-salud">
      <div id="info-salud">
          <div id="mapa">
              <button class="toggle-routing">Mostrar Ruta</button>
          </div>
      </div>
      <div id="exposición">
          <div id="exp-total">
              <p>Exposición total</p>
              <div class="expo-nivel">
                  <img src="img/carita-excelente.png" alt="cara valor">
                  <p>Excelente</p>
              </div>
          </div>
          <div id="exp-semana">
              <p>Última semana</p>
              <div class="expo-nivel">
                  <img src="img/carita-excelente.png" alt="cara valor">
                  <p>Excelente</p>
              </div>
          </div>
          <div id="exp-mes">
              <p>Último mes</p>
              <div class="expo-nivel">
                  <img src="img/carita-excelente.png" alt="cara valor">
                  <p>Excelente</p>
              </div>
          </div>
          <div id="exp-año">
              <p>Último año</p>
              <div class="expo-nivel">
                  <img src="img/carita-excelente.png" alt="cara valor">
                  <p>Excelente</p>
              </div>
          </div>
      </div>
  </div>
</div>

<script src="js/header.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script>
  cargarHeader('header_airflow.html', 'headerAir-2')
</script>
<script src="js/control-acceso.js" data-roles-restringidos="1"></script>
<script src="js/mis-medidas.js"></script>
<script src="js/crear-mapa.js"></script>
<script>
    const diasContenedor = document.getElementById('dias');
    const mesActual = document.getElementById('mes-actual');
    const mesAnterior = document.getElementById('mes-anterior');
    const mesSiguiente = document.getElementById('mes-siguiente');

    const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
    const hoy = new Date(); // Fecha actual
    let fecha = new Date();

    function cargarCalendario() {
        diasContenedor.innerHTML = ''; // Limpiar el contenedor de días
        const mes = fecha.getMonth();
        const anio = fecha.getFullYear();
        mesActual.textContent = `${meses[mes]} ${anio}`;

        const primerDiaMes = new Date(anio, mes, 1).getDay(); // Día de la semana del primer día del mes
        const diasEnMes = new Date(anio, mes + 1, 0).getDate(); // Número de días en el mes

        // Número total de celdas (42: 6 filas x 7 días)
        const totalCeldas = 42;

        // Añadir días vacíos antes del primer día del mes
        for (let i = 0; i < primerDiaMes; i++) {
            diasContenedor.innerHTML += `<span></span>`;
        }

        // Añadir los días del mes con el atributo de fecha
        for (let dia = 1; dia <= diasEnMes; dia++) {
            const estado = asignarEstado(dia); // Lógica de estado
            const fechaCompleta = `${anio}-${String(mes + 1).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
            const esHoy = anio === hoy.getFullYear() && mes === hoy.getMonth() && dia === hoy.getDate();

            diasContenedor.innerHTML += `
            <span data-date="${fechaCompleta}" data-status="${estado}">
                ${dia}
            </span>
        `;
        }

        // Añadir días vacíos después del último día del mes
        const celdasOcupadas = primerDiaMes + diasEnMes;
        const diasFaltantes = totalCeldas - celdasOcupadas;
        for (let i = 0; i < diasFaltantes; i++) {
            diasContenedor.innerHTML += `<span></span>`;
        }

        // Deshabilitar el botón "siguiente" si estamos en el mes actual
        mesSiguiente.disabled = (fecha.getFullYear() === hoy.getFullYear() && fecha.getMonth() === hoy.getMonth());

        // Agregar evento de clic a los días
        agregarEventoSeleccion();
    }


    function agregarEventoSeleccion() {
        const dias = document.querySelectorAll('#dias span[data-date]'); // Seleccionar solo los días válidos
        dias.forEach(dia => {
            dia.addEventListener('click', (e) => {
                // Remover selección previa
                document.querySelectorAll('#dias .seleccionado').forEach(d => d.classList.remove('seleccionado'));

                // Agregar clase seleccionado al día clicado
                e.target.classList.add('seleccionado');

                // Mostrar la fecha seleccionada (puedes adaptarlo)
                console.log(`Fecha seleccionada: ${e.target.dataset.date}`);
            });
        });
    }


    function asignarEstado(dia) {
        // Lógica para asignar estado: puedes adaptarlo a tus necesidades
        if (dia % 5 === 0) return 'malo';
        if (dia % 3 === 0) return 'moderado';
        if (dia % 2 === 0) return 'bueno';
        return 'excelente';
    }

    mesAnterior.addEventListener('click', () => {
        fecha.setMonth(fecha.getMonth() - 1);
        cargarCalendario();
    });

    mesSiguiente.addEventListener('click', () => {
        if (!(fecha.getFullYear() === hoy.getFullYear() && fecha.getMonth() === hoy.getMonth())) {
            fecha.setMonth(fecha.getMonth() + 1);
            cargarCalendario();
        }
    });

    // Cargar el calendario inicial
    cargarCalendario();

    // Añadir un event listener para capturar el clic en un día
    diasContenedor.addEventListener('click', function(event) {
        // Buscar el día que tiene la clase 'seleccionado'
        const diaSeleccionado = document.querySelector('#dias .seleccionado');

        if (diaSeleccionado) {
            const fechaSeleccionada = diaSeleccionado.dataset.date; // Obtener la fecha del día seleccionado
            console.log("Fecha seleccionada:", fechaSeleccionada);

            // Limpiar la ruta existente antes de obtener nuevas mediciones
            if (routingControl) {
                map.removeControl(routingControl); // Eliminar la ruta existente
            }

            // Ahora obtenemos los sensores y las mediciones para esa fecha
            obtenerMisSensores()
                .then(idsSensores => {
                    return obtenerMedicionesPorFecha(idsSensores, fechaSeleccionada); // Pasar los IDs de sensores y la fecha
                })
                .then(mediciones => {
                    console.log("Mediciones del día:", mediciones);

                    // Llamamos a la función mostrarMarcadores con las mediciones obtenidas
                    mostrarMisMarcadores(mediciones); // Mostrar los marcadores de las mediciones en el mapa

                    // Aquí puedes manejar las mediciones como desees (mostrar en el calendario, etc.)
                })
                .catch(error => {
                    console.error("Error al obtener las mediciones:", error);
                });
        } else {
            console.log("No se ha seleccionado ningún día.");
        }
    });

    // Función para mostrar los marcadores y trazar la ruta con las mediciones
    function mostrarMisMarcadores(mediciones) {
        // Limpiar los marcadores anteriores del mapa
        map.eachLayer(function(layer) {
            if (layer instanceof L.Marker) {
                map.removeLayer(layer);
            }
        });

        // Crear un array para almacenar las coordenadas de las mediciones
        const waypoints = [];

        // Añadir los marcadores para las mediciones
        mediciones.forEach(function(medicion) {
            const { latitud, longitud, tipo_gas, fecha } = medicion;

            // Asegúrate de que las coordenadas son válidas
            if (latitud && longitud) {
                const latLng = [latitud, longitud];

                // Crear un marcador para cada medición con el icono personalizado
                const marcador = L.marker(latLng, { icon: customIcon }).addTo(map);

                // Añadir información al marcador (opcional)
                marcador.bindPopup(`
                <b>Tipo de Gas:</b> ${tipo_gas}<br>
                <b>Fecha:</b> ${fecha}<br>
            `);

                // Añadir el punto a la lista de waypoints (coordenadas para la ruta)
                waypoints.push(latLng);
            }
        });

        // Si hay más de un punto, trazar la ruta
        if (waypoints.length > 1) {
            trazarRuta(waypoints);
        }
    }
    // Función para trazar la ruta entre los puntos
    function trazarRuta(waypoints) {
        // Si ya existe una ruta en el mapa, la eliminamos
        if (routingControl) {
            map.removeControl(routingControl);
        }

        // Crear una nueva ruta utilizando los waypoints (puntos) obtenidos
        routingControl = L.Routing.control({
            waypoints: waypoints.map(latLng => L.latLng(latLng)), // Convertir los puntos a formato L.LatLng
            routeWhileDragging: true, // Permite modificar la ruta arrastrando los puntos
            geocoder: L.Control.Geocoder.nominatim(), // Utiliza el geocodificador de Nominatim (si es necesario)
            createMarker: function() {
                return null;  // Evita que Leaflet Routing Machine cree los marcadores predeterminados
            }
        }).addTo(map);

        // Añadir los puntos con texto indicativo en orden
        waypoints.forEach((waypoint, index) => {
            const latLng = waypoint;

            // Crear un marcador para cada waypoint con el icono personalizado
            const marcador = L.marker(latLng, { icon: customIcon }).addTo(map);

            // Crear texto indicativo para mostrar fuera de la ruta
            const textoIndicaciones = `Punto ${index + 1} - Coordenadas: ${latLng[0].toFixed(5)}, ${latLng[1].toFixed(5)}`;
            marcador.bindPopup(textoIndicaciones);

            // Aquí puedes ajustar el texto o desplazamiento si es necesario
            // Puedes incluir información adicional como distancias, direcciones, etc.
        });
    }



</script>
</body>
</html>