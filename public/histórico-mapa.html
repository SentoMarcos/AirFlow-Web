<!doctype html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Generar Histórico Mapa</title>

    <link rel="icon" href="img/icon_retrofit.png">

    <!-- Bootstrap y estilos personalizados -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/airflow-index.css">

    <!-- Leaflet básico -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Complementos Leaflet -->
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.heat/0.2.0/leaflet-heat.js"></script>

    <style>
        #inputs{
            display: flex;
            flex-direction: column;
            margin-top: 15vh;
            position: absolute;
            z-index: 1005;
            bottom: 0;
            background: var(--v3-blanco);
            border-radius: 48px;
            padding: 25px;
        }
    </style>
</head>
<body class="loading">
<div id="header-container"></div>
<div id="inputs">
    <label for="fecha-inicio">Fecha de inicio:</label>
    <input type="date" id="fecha-inicio">

    <label for="fecha-fin">Fecha de fin:</label>
    <input type="date" id="fecha-fin">

    <button id="generar-pdf">Generar PDF Histórico</button>
    <button id="ver-medidas">Ver Medidas</button>
</div>

<div id="mapa" style="height: 100vh; width: 100%;"></div>
<div id="botones-mapa">
    <button id="centrar-ubicacion"><i class="bi bi-crosshair"></i></button>
    <!--<button id="consultar-medición" onclick="verMedidasEnUbicacion()" class="button-primary">Ver medición</button>
    <button id="cancelar-consulta" class="button-primary">Cancelar Consulta</button>-->
</div>
<script src="js/control-acceso.js" data-roles-restringidos="2"></script>
<script src="js/header.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>

<script>
    cargarHeader('header_airflow.html', 'headerAir-1')
</script>
<script src="js/mis-medidas.js"></script>
<script src="js/freeMap.js"></script>
<script src="js/premiumMap.js"></script>

<script>

    document.getElementById('generar-pdf').addEventListener("click", generarPDF);
    document.getElementById('ver-medidas').addEventListener("click", obtenerMedicionesPorFecha);
    async function generarPDF() {
        const fechaInicio = document.getElementById('fecha-inicio').value;
        const fechaFin = document.getElementById('fecha-fin').value;
        const sensores = [1,2,3];

        // Asegurarse de que el mapa esté completamente renderizado antes de capturarlo
        await new Promise((resolve) => setTimeout(resolve, 1500)); // Esperar un segundo para que termine de cargar

        document.getElementById('generar-pdf').addEventListener("click", async () => {
            const pdfDoc = await PDFLib.PDFDocument.create();

            // Configura las dimensiones de la página
            const pageWidth = 800;  // Ancho de la página en puntos
            const pageHeight = 600; // Alto de la página en puntos
            const page = pdfDoc.addPage([pageWidth, pageHeight]);

            // Título del PDF
            page.drawText('Histórico de Mapas', {
                x: 50,
                y: pageHeight - 50,
                size: 24,
            });

            // Renderizar el contenido del mapa
            html2canvas(document.getElementById('mapa'), { useCORS: true, scale: 2 }).then(async (canvas) => {
                const imgData = canvas.toDataURL('image/png');
                const img = await pdfDoc.embedPng(imgData);

                // Tamaño de la imagen dentro del PDF
                const imgWidth = pageWidth - 100; // Dejar márgenes de 50 puntos a cada lado
                const imgHeight = (img.height * imgWidth) / img.width; // Mantener proporción

                // Posición de la imagen
                const xPos = (pageWidth - imgWidth) / 2; // Centrar horizontalmente
                const yPos = (pageHeight - imgHeight) / 2; // Centrar verticalmente

                // Dibujar la imagen en la página
                page.drawImage(img, {
                    x: xPos,
                    y: yPos,
                    width: imgWidth,
                    height: imgHeight,
                });

                // Descargar el PDF
                const pdfBytes = await pdfDoc.save();
                const blob = new Blob([pdfBytes], { type: "application/pdf" });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'Historico_Mapas.pdf';
                link.click();
            });
        });

    }
</script>
</body>
</html>