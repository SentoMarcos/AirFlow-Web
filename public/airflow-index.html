<!doctype html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>AirFlow | Principal</title>
  <link rel="icon" href="img/icon_retrofit.png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/airflow-index.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-routing-machine/3.2.12/leaflet-routing-machine.min.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
    <style>
        /* Contenedor desplegable en la parte inferior */
        .leaflet-bottom.leaflet-routing-container {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            transition: transform 0.3s ease; /* Animación al desplegar/ocultar */
            transform: translateY(100%); /* Ocultar inicialmente */
            background-color: rgba(255, 255, 255, 0.9); /* Fondo semitransparente */
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }

        /* Mostrar el contenedor cuando esté desplegado */
        .leaflet-bottom.leaflet-routing-container.open {
            transform: translateY(0); /* Mostrar */
        }

        /* Botón para desplegar */
        .toggle-routing {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            border: none;
            border-radius: 5px 5px 0 0;
            padding: 10px 20px;
            cursor: pointer;
            z-index: 1001;
        }

    </style>
</head>
<body class="loading">
<div id="header-container"></div>
<div id="container-airflow">
    <div id="características">
            <div id="buscador-container">
                <img src="img/a-airflow.png" alt="a-airflow">
                <label for="buscador-airflow"><input type="search" id="buscador-airflow" placeholder="Buscar en Airflow"></label>
                <i class="bi bi-search"></i>
            </div>
            <div id="container-rutas">
                <div id="iconos-transporte">
                    <i class="bi bi-car-front-fill"></i>
                    <i class="bi bi-train-front-fill"></i>
                    <i class="bi bi-person-walking"></i>
                    <i class="bi bi-bicycle"></i>
                </div>
                <div id="puntos-ruta">
                    <div>
                    <label for="punto-inicial"><input type="search" id="punto-inicial" placeholder="Elige un punto de partida"></label>
                    <i class="bi bi-search"></i>
                    </div>
                    <div>
                    <label for="punto-final"><input type="search" id="punto-final" placeholder="Elige un destino o haz click en el mapa"></label>
                    <i class="bi bi-search"></i>
                    </div>
                </div>
            </div>
        </div>
        <!--<div id="gráfica">
            <h3>Gases</h3>
            <div id="indicador-gráfica">
                <img src="img/logo-ozono.png" alt="logo ozono">
                <div id="texto-indicador">
                    <p>Ozono 53 µg/m</p>
                    <p>Calidad excelente</p>
                </div>
                <img src="img/carita-excelente.png" alt="calidad aire">
            </div>
            <div id="chart">
                <canvas id="ozoneChart"></canvas>
            </div>
        </div>-->
    <div id="mapa">
        <button class="toggle-routing">Mostrar Ruta</button>

    </div>
</div>
<script src="js/header.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script>
  cargarHeader('header_airflow.html', 'headerAir-1')
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="js/control-acceso.js" data-roles-restringidos="1"></script>
<script>
    /*const ctx = document.getElementById('ozoneChart').getContext('2d');

    // Generar datos aleatorios asegurando al menos un valor en cada rango
    const data = [];
    const ranges = [
        { min: 25, max: 49, color: 'rgba(255, 132, 224, 1)' }, // Rosa
        { min: 50, max: 74, color: 'rgba(82, 215, 131, 1)' }, // Verde
        { min: 75, max: 99, color: 'rgba(255, 253, 132, 1)' }, // Amarillo
        { min: 100, max: 150, color: 'rgba(255, 146, 132, 1)' } // Rojo para valores mayores a 100
    ];

    // Asegurar al menos un valor en cada rango
    ranges.forEach(range => {
        data.push(Math.floor(Math.random() * (range.max - range.min + 1)) + range.min);
    });

    // Completar el resto de los datos aleatorios
    while (data.length < 24) {
        data.push(Math.floor(Math.random() * 150));
    }

    // Mezclar los datos para distribuir los valores asegurados
    data.sort(() => Math.random() - 0.5);

    const backgroundColors = data.map(value => {
        if (value <= 25) return 'rgba(255, 132, 224, 1)'; // Rosa
        if (value <= 50) return 'rgba(82, 215, 131, 1)';  // Verde
        if (value <= 75) return 'rgba(255, 253, 132, 1)';  // Amarillo
        if (value <= 100) return 'rgba(255, 146, 132, 1)'; // Rojo
        return 'rgba(255, 146, 132, 1)'; // Rojo para valores mayores a 100
    });
    const borderColors = backgroundColors;

    const ozoneChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Array.from({ length: 24 }, (_, i) => `${i}h`),
            datasets: [{
                label: 'µg/m³',
                data: data,
                backgroundColor: backgroundColors,
                borderColor: borderColors,
                borderWidth: 1
            }]
        },
        options: {
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                x: {
                    grid: {
                        display: false
                    }
                },
                y: {
                    beginAtZero: true,
                    max: 300,
                    ticks: {
                        stepSize: 50
                    },
                    grid: {
                        display: false
                    }
                }
            }
        }
    });*/
</script>
<script>
    // Variables globales para los marcadores y la capa de ruta
    let startMarker = null;
    let endMarker = null;
    let routingControl = null;

    // Inicializa el mapa con una ubicación inicial genérica
    var map = L.map('mapa', {
        zoomControl: false // Deshabilita el control de zoom predeterminado
    }).setView([51.505, -0.09], 13);

    // Agrega el mapa base
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // Añade el control de zoom en la esquina inferior izquierda
    L.control.zoom({
        position: 'bottomright' // Cambia la posición del control de zoom
    }).addTo(map);

    // Define el icono personalizado
    var customIcon = L.icon({
        iconUrl: 'img/ubicacion-marker.png', // Reemplaza con la URL de tu icono
        iconSize: [32, 48], // Tamaño del icono en píxeles
        iconAnchor: [16, 32], // Punto de anclaje del icono (centro en la parte inferior)
    });

    // Usa la geolocalización del navegador para obtener tu ubicación
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function (position) {
                // Obtiene las coordenadas del usuario
                var lat = position.coords.latitude;
                var lng = position.coords.longitude;

                // Centra el mapa en las coordenadas del usuario
                map.setView([lat, lng], 13);

                // Agrega un marcador con el icono personalizado en la ubicación del usuario
                L.marker([lat, lng], { icon: customIcon }).addTo(map);
            },
            function (error) {
                console.error('Error al obtener la ubicación: ', error);
            }
        );
    } else {
        console.error('Geolocalización no es compatible con este navegador.');
    }

    // Asegura que el mapa se ajusta correctamente en pantalla completa
    setTimeout(() => {
        map.invalidateSize();
    }, 300);

    // Función para realizar la geocodificación usando Nominatim
    async function geocodeAddress(query) {
        const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=1`;
        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`Geocoding error: ${response.status}`);
            }
            const data = await response.json();
            return data[0]; // Retorna el primer resultado
        } catch (error) {
            console.error('Error al buscar la dirección:', error);
            return null;
        }
    }

    // Función para manejar la entrada de texto y mover el marcador
    async function handleInputSearch(event) {
        if (event.key === 'Enter') { // Ejecutar cuando se presione Enter
            const input = event.target;
            const query = input.value;

            // Realiza la búsqueda de la dirección
            const location = await geocodeAddress(query);
            if (location) {
                const latlng = {
                    lat: parseFloat(location.lat),
                    lng: parseFloat(location.lon),
                };

                if (input.id === 'punto-inicial') {
                    setMarker(latlng, 'start');
                } else if (input.id === 'punto-final') {
                    setMarker(latlng, 'end');
                }

                // Centrar el mapa en la ubicación
                map.setView(latlng, 15);

                // Si ambos puntos están definidos, trazar la ruta
                if (startMarker && endMarker) {
                    traceRoute();
                }
            } else {
                alert('Dirección no encontrada. Intente con otra.');
            }
        }
    }

    // Vincular el evento "keypress" para ambos inputs
    document.getElementById('punto-inicial').addEventListener('keypress', handleInputSearch);
    document.getElementById('punto-final').addEventListener('keypress', handleInputSearch);

    // Función para establecer marcadores en el mapa
    function setMarker(latlng, type) {
        if (type === 'start') {
            if (startMarker) map.removeLayer(startMarker);
            startMarker = L.marker(latlng).addTo(map);
            document.getElementById('punto-inicial').value = `${latlng.lat.toFixed(5)}, ${latlng.lng.toFixed(5)}`;
        } else if (type === 'end') {
            if (endMarker) map.removeLayer(endMarker);
            endMarker = L.marker(latlng).addTo(map);
            document.getElementById('punto-final').value = `${latlng.lat.toFixed(5)}, ${latlng.lng.toFixed(5)}`;
        }
    }

    // Función para trazar una ruta entre dos puntos
    function traceRoute() {
        // Si ya hay una ruta trazada, eliminarla
        if (routingControl) {
            map.removeControl(routingControl);
        }

        // Crear un nuevo control de enrutamiento
        routingControl = L.Routing.control({
            waypoints: [
                startMarker.getLatLng(), // Coordenadas del punto inicial
                endMarker.getLatLng()   // Coordenadas del punto final
            ],
            routeWhileDragging: true, // Permite modificar la ruta arrastrando
            geocoder: L.Control.Geocoder.nominatim() // Geocodificador de Nominatim
        }).addTo(map);
    }








    // Selecciona el botón de alternar y el contenedor de rutas
    const toggleButton = document.querySelector('.toggle-routing');

    // Agregar evento de clic para alternar el contenedor de rutas
    toggleButton.addEventListener('click', () => {
        const routingContainer = document.querySelector('.leaflet-bottom.leaflet-routing-container');
        routingContainer.classList.toggle('open');

        // Cambiar el texto del botón según el estado
        if (routingContainer.classList.contains('open')) {
            toggleButton.textContent = 'Ocultar Ruta';
        } else {
            toggleButton.textContent = 'Mostrar Ruta';
        }
    });

    // Configura Leaflet Routing Machine para agregar la clase necesaria
    function traceRoute() {
        if (routingControl) {
            map.removeControl(routingControl);
        }

        routingControl = L.Routing.control({
            waypoints: [
                startMarker.getLatLng(),
                endMarker.getLatLng()
            ],
            routeWhileDragging: true,
            geocoder: L.Control.Geocoder.nominatim()
        }).addTo(map);

        // Agrega una clase al contenedor de rutas para personalizar su posición
        const routingContainer = document.querySelector('.leaflet-routing-container');
        if (routingContainer) {
            routingContainer.classList.add('leaflet-bottom');
        }
    }

</script>


<!--Calidad aire-->
<script>

    // Clave de API de OpenWeatherMap
    const apiKey = "bc28af6f5f9fbf476f6ee1d5836b002a";
    const airPollutionEndpoint = "https://api.openweathermap.org/data/2.5/air_pollution";

    // Función para obtener datos de contaminación y añadirlos al mapa
    async function getAirPollutionData(lat, lon) {
        const url = `${airPollutionEndpoint}?lat=${lat}&lon=${lon}&appid=${apiKey}`;
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`Error: ${response.statusText}`);
            const data = await response.json();

            // Extraer datos de calidad del aire
            const { list } = data;
            const { main, components } = list[0];

            // Crear un popup con información
            const popupContent = `
                    <b>Calidad del Aire</b><br>
                    AQI (Índice de Calidad del Aire): ${main.aqi}<br>
                    PM2.5: ${components.pm2_5} µg/m³<br>
                    PM10: ${components.pm10} µg/m³<br>
                    O3: ${components.o3} µg/m³<br>
                    NO2: ${components.no2} µg/m³<br>
                `;

            // Añadir un marcador en el mapa
            L.marker([lat, lon]).addTo(map).bindPopup(popupContent).openPopup();
        } catch (error) {
            console.error("Error al obtener datos de calidad del aire:", error);
        }
    }

    // Obtener datos para una ubicación específica
    getAirPollutionData(39.47, -0.38); // Coordenadas para Valencia, España
</script>
</body>
</html>